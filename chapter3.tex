\chapter{Численные эксперименты}
В данной главе применим решим практически задачу оптимального управления для неоклассической модели экономики c логарифмической функцией мгновенной полезности методом МРС как базовым способом (критерий типа Лагранжа), так и с добавлением терминальной стоимости (критерий типа Майера) и сравним их.
\section{Применение метода MPC к решению задачи об экономическом росте}
Рассмотрим задачу (2.14).
    $$ J(x,u) = \int_{0}^{\infty}e^{-\rho t}[\ln(1-u(t))+\ln f(x(t))]dt \rightarrow \max.$$
	$$ \dot{x}(t) = u(t) f(x(t))-\mu x(t),u (t)\in U_\varepsilon = [0 ,1-\varepsilon], $$
	$$ x(0) = x_0, x \ge 0$$

Цель данной главы применить методы решения ЗОУ для решения данной задачи.
Для решения задачи воспользуемся алгоритмом, который был указан в пунтке 1.3. Рассматривать будем прогнозирующую задачу с критерием типа Лагранжа, т.е.
$$ J(x,u) =  \int_{\tau}^{\tau+z} e^{-\rho t}[\ln(1-u(t))+\ln f(x(t))]dt $$
Решение задачи будем искать численно в классе кусочно-постоянных функций, то есть
$$ u(t) = u_i, t \in [ih, (i+1)h], i = 0,...,T-1 $$
где $ h = z/T $ - период дискретизации, $ T \in \mathbb{N}$, $ T $ - количество интервалов квантования.\\
Фазовая же переменная $ x $ и уравнение для её рассчета изменятся следующим образом:
$$ x_{i+1} = u_i f(x_i)-\mu x_i$$

В таком случае критерий качества нашей задачи имеет следующий вид:
$$ J(x,u) = \sum_{i=0}^{T-1}\int_{ih}^{(i+1)h} e^{-\rho t}[\ln(1-u_i)+\ln f(x_i)]dt =$$  $$ \sum_{i=0}^{T-1}\dfrac{[\ln(1-u_i)+\ln f(x_i)]}{-\rho} \left(e^{-\rho(i+1)h} -  e^{-\rho ih}\right)$$
В итоге мы получаем следующую дискретизированую задачу:
$$ x_{i+1} = u_i f(x_i)-\mu x_i, u_i\in U_\varepsilon = [0 ,1-\varepsilon], x(0) = x_0, x_i \ge 0$$
$$ J(x,u) = \sum_{i=0}^{T-1}\dfrac{[\ln(1-u_i)+\ln f(x_i)]}{-\rho} \left(e^{-\rho(i+1)h} -  e^{-\rho ih}\right)$$

Однако решение задачи с критерием типа Лагранжа имеет важный недостаток в виде слишком длинного горизонта планирования (что будет подтверждено позднее при численных экспериментах). Одним из вариантов, исправляющим эту проблему является добавление терминального ограничения-равенства к задаче
$$ J(x,u) = \sum_{i=0}^{T-1}\dfrac{[\ln(1-u_i)+\ln f(x_i)]}{-\rho} \left(e^{-\rho(i+1)h} -  e^{-\rho ih}\right)$$
$$ x_{i+1} = u_i f(x_i)-\mu x_i, u_i\in U_\varepsilon = [0 ,1-\varepsilon], x(0) = x_0, x(\tau + z) = \hat{x}, x_i \ge 0$$
т.е. добавляется требование, чтобы фондовооруженность к моменту $ \tau + z $ равнялась магистральному значению. Не являясь идеальным способом, данный вариант все же представляет гораздо более простой варианты для решения задачи.

Наименее трудоемким вариантом будет использлвать задачу с критерием типа Майера. Для этого необходимо добавить к уже имеющейся задаче с критерием типа Лагранжа термильнальную стоимость.
\begin{equation}
J(x,u) = W(x(\tau+z)) + \int_{\tau}^{\tau+z}L(x(t),u(t))dt \rightarrow \max.
\end{equation}
$$ \dot{x}(t) = u(t) f(x(t))-\mu x(t),u (t)\in U_\varepsilon = [0 ,1-\varepsilon], $$
$$ x_0 = x(0).$$
Для того, чтобы выбрать подходящую терминальную стоимость $ W $, запишем условия
оптимальности (условия Каруша-Куна-Таккера) для задачи нелинейного программирования:
\begin{equation}
\partial L(x,u)/\partial x + (\partial f(x,u)/\partial x)^T p = 0,
\end{equation}
 $$\partial L(x,u)/\partial u + (\partial f(x,u)/\partial u)^T p = 0, f(x,u) = 0.$$
Пара $ (\hat{x}, \hat{u}) $ необходимо удовлетворяет условиям вместе с некоторым (оптимальным) множителем Лагранжа $ \hat{p} $.

Вернемся теперь к прогнозирующей задаче ОУ. Управление $ u(t) \equiv \hat{u} $, соответствующие ему прямая траектория $ x(t) \equiv \hat{x} $ и сопряженная траектория $ \psi(t) \equiv \hat{p} $, т.е. магистраль,
является решением гамильтоновой системы принципа максимума
\begin{equation}
\dot{\psi} = -(\partial f(x(t),u(t))/\partial x)^T \psi(t) + \partial L(x(t),u(t))/\partial x,
\end{equation} $$ \dot{x} = f(x(t),u(t)), t \in [\tau, \tau+z],$$
при начальном условии $ x(t) = \hat{x} $, и условии трансверсальности $ \psi(z) = -\hat{p} $.
Для того, чтобы в задаче 2.17 получить условие трансверсальности $ \psi(\tau+z) = -\hat{p} $ , выберем линейную терминальную стоимость $ W(x) = \hat{p}^Tx $. Тогда $ \psi(\tau+z) = -\partial W(x(\tau+z))/\partial x = -\hat{p} $

В результате, указав что терминальная стоимость содержит дисконтирующий множитель $ W(x,\tau+z) = e^{-\rho (\tau+z)}\hat{p}x$ получим следующую прогнозирующую задачу:
\begin{equation}
J(x,u) = e^{-\rho (\tau+z)}\hat{p}x + \int_{0}^{\infty}e^{-\rho t}[\ln(1-u(t))+\ln f(x(t))]dt \rightarrow \max,
\end{equation}
$$ \dot{x}(t) = u(t) f(x(t))-\mu x(t),u (t)\in U_\varepsilon = [0 ,1-\varepsilon], $$
$$ x(0) = x_0, x \ge 0$$
Далее, используя аналогичные задаче без терминальной стоимости, вычисления, перейдем сразу к программируемой задаче:
\begin{equation}
J(x,u) = e^{-\rho (\tau+z)}\hat{p}_{T} + \sum_{i=0}^{T-1}\dfrac{[\ln(1-u_i)+\ln f(x_i)]}{-\rho} \left(e^{-\rho(i+1)h} -  e^{-\rho ih}\right),
\end{equation}
$$ \dot{x}(t) = u(t) f(x(t))-\mu x(t),u (t)\in U_\varepsilon = [0 ,1-\varepsilon], $$
$$ x(0) = x_0, x \ge 0$$

Таким образом, задача оптимального управления в классе дискретных управляющих воздействий свелась к задаче нелинейного прогаммирования. Для ее численного решения существует ряд реализованных программно процедур, в частности, в рамках курсовой работы будет использвоаться стандартная процедура fminsearch пакета Matlab. Нам теперь необходимо запрограммировать оба алгоритма и сравнить их.

В качестве производственной функции рассматриваем:
$$ f(x) = x^\alpha $$
В задаче будем использовать следующие параметры: $ z = 10, \alpha = 0.3, \mu = 0.03, \rho = 0.05, \varepsilon = 0.01 $.\\ \\
Решая уравнения для устойчивого состояния (магистраль) получим
$$ \hat{x} = 6.6076, \hat{u} = 0.11250, \hat{p} = 0.6395$$
\section{Программное решение}
Для рассчета состояния в следующий момент времени опредилим функции applycontrol на основе ode45 и deq, в качестве переменной для ode45:
\begin{lstlisting}
function x = applycontrol(t,k,c)
[~, x] = ode45(@(t,k) deq(k,c),[t, t+dt], k);
x = x(end,:);
end

function dk = deq(k,c)
dk = c*k^(alpha) - mu*k;
end
\end{lstlisting}
Здесь $ k $ --- начальное состояние, c управление, $ t $ --- начальный момент времени. Определим функцию mpcsolve для решения задачи методом управления с прогнозирующей моделью. 

Чтобы в дальнейшем иметь возможность ее повторного использования для решения других задач реализуем ее в общем виде, независящем от рассматриваемой в данной работе задачи. Для решения задачи на конечном промежутке будем использовать реализованную в Matlab функцию fmincon, минимизирующую функцию при заданных линейных и нелинейных ограничениях. Также определим функцию полной стоимости costfun, суммирующую функции стоимости этапа. Для дальнейшего анализа решения функция mpcsolve возвращает не только построенные оптимальную траекторию и последовательность управлений, но и все траектории и управления для задач на конечном промежутке, полученные при решении задачи на каждой итерации.
\begin{lstlisting}
function [x, u] = mpcsolve(Nmpc, x0, t0, u0)
t = t0;
x = zeros(N + 1,Nmpc);
x(1,1) = x0; 
u = zeros(N,Nmpc);
for i = 1:Nmpc
u(:, i) = fmincon(@(u) costfun(x(1,i),t,u),...
u0,[],[],[],[],zeros(N,1),ones(N,1)-eps);
for j = 1:N
x(j+1,i) = applycontrol(t + j*dt,x(j,i),u(j,i));
end
x(1,i+1) = x(2,i);
t = t + dt;
end
end
function cost = costfun(x0,t0,u) 
cost = 0; 
x = x0; 
t = t0; 
for i = 1:N
cost = cost + stagecost(t, x, u(i));
x = applycontrol(t,x,u(i));
t = t + dt;
end
cost = cost + termcost(t0, x);
end
function r = stagecost(t, k, c)
r = (log(1 - c) + log(k^alpha))*...
(exp(-rho * (t+dt))-exp(-rho * t))/rho;
end
\end{lstlisting}

Для получения результата вызовем функцию mpcsolve
\begin{lstlisting}
[k, c] = mpcsolve(Nmpc, k0, t0, 0.3*ones(N,1));
\end{lstlisting}
\section{Результаты исследования}
В качестве начальных данных Т (горизонт планирования) положим равным 10, рассматривать нашу задачу будем как минимум для трех различных горизонтов: 10, 30, 50. В качестве начальных условий везде используется $ x_0 = 1 $, период квантования $ h = 1 $. Для начала, рассмотрим данную задачу без терминального слагаемого.
\begin{figure}[h]
	\includegraphics[scale=0.5]{figure1.1}
	\includegraphics[scale=0.4]{figure1.2}
	\caption{Траектории $ x $ и $ u $ при $ z  = 10 $}
\end{figure}
\begin{figure}[h]
	\includegraphics[scale=0.5]{figure2.1}
	\includegraphics[scale=0.4]{figure2.2}
	\caption{Траектории $ x $ и $ u $ при $ z $ = 30}
\end{figure}
\begin{figure}[h]
	\includegraphics[scale=0.5]{figure3.1}
	\includegraphics[scale=0.4]{figure3.2}
	\caption{Траектории $ x $ и $ u $ при $ z $ = 50}
\end{figure}

Очевидно, что с увеличением горизонта планирования наша траектория приближается к устойчивому состоянию $ \hat{x} $.\\
Так же следует отметить, что при увеличении горизонта нелинейно возрастает и время решения задачи. Здесь представлены траектории вплоть до $ z = 50 $. Учитывая динамику можно предположить, что при $ z \approx 90 $ траектория $ x $ совпадет с магистралью.

На рис. 3.1 --- 3.3 можно наблюдать эффект критерия Лагранжа: программные траектории (штриховые линии) покидают траекторию на заключительном участке, чтобы выполнить условие трансверсальности. Понятно, что на построение этих участков численная процедура решения задачи нелинейного программирования вынуждена тратить некоторое дополнительное время.

Решая ту же задачу с ограничением-равенством замечаем, что все функции на отрезке $ t $ являются возрастающими. Траектории замкнутой системы и управления (рис. 3.4) стремятся к магистральным значениям. Это требование выполняется при условии, что задача с данным ограничением имеет решение в позиции (0, $ x_0 $).

Так же следует отметить, что из-за жесткости условия существуют такие наборы начальных параметров, при которых не существует ни одного допустимого управления, приводящего систему в магистральное состояние. В данной задаче решения не существуют при $ z \le 6 $.

Таким образом можно сказать что недостатками EMPC с терминальным ограничением-равенством является трудоемкость решения и начальная недопустимость некоторых значений.

Теперь же, использовав аналогичные данные, но уже без дополнительных ограничений, добавим терминальную стоимость. 
Очевидно, что при её добавлении устойчивое состояние достигается гораздо быстрее и с гораздо меньшими трудозатратами. На рис. 3.5 изображены траектории при $ z = 10 $ и $ \tau = [0; 20] $. Видим, что $ x $ и $ u $ стремятся к магистрали на меньшем горизонте, что покажем, увеличив $ t $ до $ 100 $ (рис. 3.6). Аналогично будут выглядеть графики при меньшем $ z $.

По полученным данным можно сделать вывод, что при использовании терминального слагаемого траекторию, выходящую на магистраль, можно получить при любом горизонте $ z $. Хотя при использовании терминального слагаемого время при прочих равных условиях работа программы несколько выше, при использовании терминального слагаемого можно значительно сократить время вычислений за счет выбора значительно меньшего горизонта планирования.
\begin{figure}[h]
	\includegraphics[scale=0.6]{figure6}
	\caption{Траектории $ x $ и $ u $ при $ z $ = 10 и $ t $ = 50 }
\end{figure}
\begin{figure}[h]
		\includegraphics[scale=0.5]{figure4.1}
		\includegraphics[scale=0.4]{figure4.2}
		\caption{Траектории $ x $ и $ u $ при $ z $ = 10 и $ \tau = [0;20] $}
\end{figure}
\begin{figure}[h]
		\includegraphics[scale=0.5]{figure5.1}
		\includegraphics[scale=0.4]{figure5.2}
		\caption{Траектории $ x $ и $ u $ при $ z $ = 10 и $ t $ = 100 }
\end{figure}
